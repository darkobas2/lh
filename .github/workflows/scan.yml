name: Check for updates
on:
  schedule:
    - cron: '9 9 * * *'

  push:
    branch:
      - '**'
jobs:
  scan:
    name: List Recent Updates
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: scan.yml
          workflow_conclusion: success
          name: latest-image
          # Optional, a directory where to extract artifact(s), defaults to the current directory
          path: .
          if_no_artifact_found: warn
      - name: test
        run: cat RESULT
        continue-on-error: true
      - name: get image
        run: |
             RESULT_NEW=$(curl -s https://registry.hub.docker.com/v2/repositories/sigp/lighthouse/tags |jq -r '.results[] |select(.name |test("v[0-9]+.[0-9]+.[0-9]+-modern"))|.name')
             if [ -f RESULT];then  RESULT=${< RESULT};fi
             echo "$RESULT $RESULT_NEW"
             if [ "$RESULT" != "$RESULT_NEW" ]; then echo "::set-output name=TRIGGER::true";fi
             echo "::set-output name=LATEST_RESULT::${RESULT_NEW}"
             echo "${RESULT_NEW}" > RESULT
        id: scan
      - name: Print
        run: "echo 'Recent updates: ${{ steps.scan.outputs.LATEST_RESULT }}'"
      - name: Tag Repo
        uses: richardsimko/update-tag@v1.0.5
        if: steps.scan.outputs.TRIGGER
        with:
          tag_name: ${{ steps.scan.outputs.LATEST_RESULT }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Archive results
        uses: actions/upload-artifact@v3
        with:
          name: latest-image
          path: RESULT
          retention-days: 2
